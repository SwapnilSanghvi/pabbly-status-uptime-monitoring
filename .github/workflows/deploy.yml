name: Deploy to Hetzner

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Allow manual trigger

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e

            echo "=== Deploying Pabbly Status Monitor ==="

            # Navigate to application directory
            cd /root/pabbly-status-uptime-monitoring

            # Pull latest code
            echo "Pulling latest code from GitHub..."
            git pull origin main

            # Install backend dependencies
            echo "Installing backend dependencies..."
            cd backend
            npm install --production
            cd ..

            # Build frontend
            echo "Building frontend..."
            cd frontend
            npm install
            npm run build
            cd ..

            # Run database migrations
            echo "Running database migrations..."
            for file in database/migrations/*.sql; do
              echo "Processing $file..."
              psql -U status_user -d status_monitor -f "$file" 2>&1 | grep -v 'already exists' || true
            done

            # Restart backend with PM2
            echo "Restarting backend service..."
            pm2 restart pabbly-status-backend

            # Reload Nginx
            echo "Reloading Nginx..."
            systemctl reload nginx

            # Health check
            echo "Checking service health..."
            sleep 3
            pm2 status | grep pabbly-status-backend

            echo "=== Deployment completed successfully! ==="

      - name: Verify Deployment
        run: |
          echo "Waiting for service to be ready..."
          sleep 5

          # Check if site is accessible
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://monitor.pabbly.com/health || echo "000")

          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "✅ Deployment successful! Site is accessible."
          else
            echo "❌ Deployment may have issues. HTTP status code: $HTTP_CODE"
            exit 1
          fi

      - name: Deployment Status
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ job.status }}';
            const message = status === 'success'
              ? '✅ Deployment to monitor.pabbly.com successful!'
              : '❌ Deployment failed. Check logs for details.';

            console.log(message);

            // Create deployment event
            github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: context.payload.deployment?.id || 0,
              state: status === 'success' ? 'success' : 'failure',
              description: message,
              environment_url: 'https://monitor.pabbly.com'
            }).catch(() => console.log('Could not create deployment status'));
